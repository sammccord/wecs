function e(e,s){return e[s.name]}function s(e,s){return!!e[s.name]}function t(e,s){return s.every(s=>!!e[s.name])}export default class{constructor(e){this.config={},this._systems=[],this._entities=[],this._queries={},this.config=e||{}}makeQueryKey(e){return e.map(e=>e.name).sort().join("-")}queryWithKey(e,s){return this._queries[e]?this._queries[e].entities:this._entities.filter(e=>t(e,s))}_handleAddCallbacks(e){Object.values(this._queries).forEach(s=>{s.entities.includes(e)||s.components.every(s=>!!e[s.name])&&(s.entities.push(e),s.callbacks.forEach(e=>e(s.entities)))})}_handleRemoveCallbacks(e){Object.values(this._queries).forEach(s=>{s.entities.includes(e)&&(s.components.every(s=>!!e[s.name])||(s.entities.splice(s.entities.indexOf(e),1),s.callbacks.forEach(e=>e(s.entities))))}),~Object.keys(e).length||this._entities.splice(this._entities.indexOf(e),1)}addComponent(e,s){for(var t=arguments.length,i=new Array(t>2?t-2:0),n=2;n<t;n++)i[n-2]=arguments[n];e[s.name]=new s(...i),this._handleAddCallbacks(e)}addComponents(e,s){~s.length&&(s.forEach(s=>{var[t,...i]=s;e[t.name]=new t(...i)}),this._handleAddCallbacks(e))}createEntity(e){var s={};return e.forEach(e=>{var[t,...i]=e;s[t.name]=new t(...i)}),this._entities.push(s),Object.values(this._queries).forEach(e=>{e.components.every(e=>!!s[e.name])&&e.entities.push(s),e.callbacks.forEach(s=>s(e.entities))}),s}query(e){var s=this.makeQueryKey(e);return this.queryWithKey(s,e)}register(e,s){var t=this.makeQueryKey(s);this._systems.push([e,t]),this._queries[t]={components:s,entities:[],callbacks:[]}}removeComponent(e,s){s&&(delete e[s.name],this._handleRemoveCallbacks(e))}removeComponents(e,s){s&&~s.length&&(s.forEach(s=>{delete e[s.name]}),this._handleRemoveCallbacks(e))}async run(){for(var e=arguments.length,s=new Array(e),t=0;t<e;t++)s[t]=arguments[t];if(this.config.onBefore&&await this.config.onBefore(...s),this.config.parallel)this._systems.forEach(e=>{var[t,i]=e;s?t(...s,this._queries[i].entities):t(this._queries[i].entities)});else for(var[i,n]of this._systems)s?await i(...s,this._queries[n].entities):await i(this._queries[n].entities);this.config.onAfter&&await this.config.onAfter(...s)}subscribe(e,s,t){var i=this.makeQueryKey(e),n=this.queryWithKey(i,e);return this._queries[i]?this._queries[i].callbacks.push(s):this._queries[i]={components:e,entities:n,callbacks:[s]},t&&s(n),()=>{this._queries[i]&&this._queries[i].callbacks.splice(this._queries[i].callbacks.indexOf(s),1)}}unsubscribe(e,s){var t=this.makeQueryKey(e);this._queries[t]&&this._queries[t].callbacks.splice(this._queries[t].callbacks.indexOf(s),1)}updateComponent(e,s,t){e[s.name]=t(e[s.name])||e[s.name],Object.values(this._queries).forEach(s=>{s.entities.includes(e)&&s.callbacks.forEach(e=>e(s.entities))})}}export{e as getComponent,s as hasComponent,t as hasComponents};
//# sourceMappingURL=index.modern.js.map
