const e=class{constructor(e={}){Object.assign(this,e)}};class s extends e{}function t(e){return e[s.name].id}function i(e,s){return e[s.name]}function n(e,s){return!!e[s.name]}function r(e,s){return s.every(s=>!!e[s.name])}class a{constructor(e={}){this.config={},this._systems=[],this._entities={},this._queries={},this.config=e}makeQueryKey(e){return e.map(e=>e.name).sort().join("-")}queryWithKey(e,s,t){if(this._queries[e])return this._queries[e].entities;const i=Object.values(this._entities).filter(e=>r(e,s));return t&&(this._queries[e]={components:s,entities:i,subscriptions:[],changeHandlers:[]}),i}_handleAddCallbacks(e){Object.values(this._queries).forEach(s=>{s.entities.includes(e)||r(e,s.components)&&(s.entities.push(e),s.subscriptions.forEach(e=>e(s.entities)))})}_handleRemoveCallbacks(e){Object.values(this._queries).forEach(s=>{s.entities.includes(e)&&(r(e,s.components)||(s.entities.splice(s.entities.indexOf(e),1),s.subscriptions.forEach(e=>e(s.entities))))}),1===Object.keys(e).length&&delete this._entities[e.ID.id]}addComponent(e,s,...t){e[s.name]=new s(...t),this._handleAddCallbacks(e)}addComponents(e,s){~s.length&&(s.forEach(([s,...t])=>{e[s.name]=new s(...t)}),this._handleAddCallbacks(e))}createEntity(e){const t={};return e.forEach(([e,...s])=>{t[e.name]=new e(...s)}),t.ID||(t.ID=new s({id:String((new Date).valueOf())})),this._entities[t.ID.id]=t,Object.values(this._queries).forEach(e=>{r(t,e.components)&&e.entities.push(t),e.subscriptions.forEach(s=>s(e.entities))}),t}get(e){return this._entities[e]}query(e,s){const t=this.makeQueryKey(e);return this.queryWithKey(t,e,s)}register(e,s){const t=this.makeQueryKey(s);this._systems.push([e,t]),this._queries[t]={components:s,entities:[],subscriptions:[],changeHandlers:[]}}removeComponent(e,t){t&&t.name!==s.name&&(delete e[t.name],this._handleRemoveCallbacks(e))}removeComponents(e,t){t&&~t.length&&(t.forEach(t=>{t.name!==s.name&&delete e[t.name]}),this._handleRemoveCallbacks(e))}async run(...e){if(this.config.onBefore&&await this.config.onBefore(...e),this.config.parallel)this._systems.forEach(([s,t])=>{e?s(...e,this._queries[t].entities):s(this._queries[t].entities)});else for(let[s,t]of this._systems)e?await s(...e,this._queries[t].entities):await s(this._queries[t].entities);this.config.onAfter&&await this.config.onAfter(...e)}subscribe(e,s,t){return this.makeSubscription(e,t)(s)}makeSubscription(e,s){const t=this.makeQueryKey(e);return i=>{const n=this.queryWithKey(t,e);return this._queries[t]?this._queries[t].subscriptions.push(i):this._queries[t]={components:e,entities:n,subscriptions:[i],changeHandlers:[]},s&&i(n),()=>{this._queries[t]&&this._queries[t].subscriptions.splice(this._queries[t].subscriptions.indexOf(i),1)}}}handleChange(e,s){return this.makeChangeHandler(e)(s)}makeChangeHandler(e){const s=this.makeQueryKey(e);return t=>(this._queries[s]?this._queries[s].changeHandlers.push(t):this._queries[s]={components:e,entities:this.queryWithKey(s,e),subscriptions:[],changeHandlers:[t]},()=>{this._queries[s]&&this._queries[s].changeHandlers.splice(this._queries[s].changeHandlers.indexOf(t),1)})}unsubscribe(e,s){const t=this.makeQueryKey(e);this._queries[t]&&this._queries[t].subscriptions.splice(this._queries[t].subscriptions.indexOf(s),1)}deregisterHandler(e,s){const t=this.makeQueryKey(e);this._queries[t]&&this._queries[t].subscriptions.splice(this._queries[t].changeHandlers.indexOf(s),1)}updateComponent(e,s,t){const i=this._update(e,s,t);return Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&(t.subscriptions.forEach(e=>e(t.entities)),t.changeHandlers.forEach(t=>t(e,[[s,i]])))}),i}updateComponents(e,s){const t=s.map(([s,t])=>[s,this._update(e,s,t)]);return Object.values(this._queries).forEach(s=>{s.entities.includes(e)&&(s.subscriptions.forEach(e=>e(s.entities)),s.changeHandlers.forEach(s=>s(e,t)))}),t}_update(e,s,t){return e[s.name]="function"==typeof t?t(e[s.name])||e[s.name]:t,e[s.name]}}export{e as Component,s as ID,a as World,i as getComponent,t as getID,n as hasComponent,r as hasComponents};
//# sourceMappingURL=index.modern.js.map
