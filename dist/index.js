const e="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function t(e,i,s){if(!e.s){if(s instanceof n){if(!s.s)return void(s.o=t.bind(null,e,i));1&i&&(i=s.s),s=s.v}if(s&&s.then)return void s.then(t.bind(null,e,i),t.bind(null,e,2));e.s=i,e.v=s;const r=e.o;r&&r(e)}}const n=function(){function e(){}return e.prototype.then=function(n,i){const s=new e,r=this.s;if(r){const e=1&r?n:i;if(e){try{t(s,1,e(this.v))}catch(e){t(s,2,e)}return s}return this}return this.o=function(e){try{const r=e.v;1&e.s?t(s,1,n?n(r):r):i?t(s,1,i(r)):t(s,2,r)}catch(e){t(s,2,e)}},s},e}();function i(e){return e instanceof n&&1&e.s}function s(e,t){return t.every(t=>!!e[t.name])}exports.Component=class{constructor(e={}){Object.assign(this,e)}},exports.World=class{constructor(e={}){this.config={},this._systems=[],this._entities=[],this._queries={},this.config=e}makeQueryKey(e){return e.map(e=>e.name).sort().join("-")}queryWithKey(e,t,n){if(this._queries[e])return this._queries[e].entities;const i=this._entities.filter(e=>s(e,t));return n&&(this._queries[e]={components:t,entities:i,callbacks:[]}),i}_handleAddCallbacks(e){Object.values(this._queries).forEach(t=>{t.entities.includes(e)||s(e,t.components)&&(t.entities.push(e),t.callbacks.forEach(e=>e(t.entities)))})}_handleRemoveCallbacks(e){Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&(s(e,t.components)||(t.entities.splice(t.entities.indexOf(e),1),t.callbacks.forEach(e=>e(t.entities))))}),~Object.keys(e).length||this._entities.splice(this._entities.indexOf(e),1)}addComponent(e,t){e[t.name]=new t(...[].slice.call(arguments,2)),this._handleAddCallbacks(e)}addComponents(e,t){~t.length&&(t.forEach(([t,...n])=>{e[t.name]=new t(...n)}),this._handleAddCallbacks(e))}createEntity(e){const t={};return e.forEach(([e,...n])=>{t[e.name]=new e(...n)}),this._entities.push(t),Object.values(this._queries).forEach(e=>{s(t,e.components)&&e.entities.push(t),e.callbacks.forEach(t=>t(e.entities))}),t}query(e,t){const n=this.makeQueryKey(e);return this.queryWithKey(n,e,t)}register(e,t){const n=this.makeQueryKey(t);this._systems.push([e,n]),this._queries[n]={components:t,entities:[],callbacks:[]}}removeComponent(e,t){t&&(delete e[t.name],this._handleRemoveCallbacks(e))}removeComponents(e,t){t&&~t.length&&(t.forEach(t=>{delete e[t.name]}),this._handleRemoveCallbacks(e))}run(){try{const o=this;function s(){function s(){const e=function(){if(o.config.onAfter)return Promise.resolve(o.config.onAfter(...r)).then(function(){})}();if(e&&e.then)return e.then(function(){})}const c=function(){if(!o.config.parallel)return function(s,r,o){if("function"==typeof s[e]){var c,u,a,h=s[e]();if(function e(s){try{for(;!(c=h.next()).done;)if((s=r(c.value))&&s.then){if(!i(s))return void s.then(e,a||(a=t.bind(null,u=new n,2)));s=s.v}u?t(u,1,s):u=s}catch(e){t(u||(u=new n),2,e)}}(),h.return){var l=function(e){try{c.done||h.return()}catch(e){}return e};if(u&&u.then)return u.then(l,function(e){throw l(e)});l()}return u}if(!("length"in s))throw new TypeError("Object is not iterable");for(var f=[],m=0;m<s.length;m++)f.push(s[m]);return function(e,s,r){var o,c,u=-1;return function r(a){try{for(;++u<e.length;)if((a=s(u))&&a.then){if(!i(a))return void a.then(r,c||(c=t.bind(null,o=new n,2)));a=a.v}o?t(o,1,a):o=a}catch(e){t(o||(o=new n),2,e)}}(),o}(f,function(e){return r(f[e])})}(o._systems,function([e,t]){const n=r?Promise.resolve(e(...r,o._queries[t].entities)).then(function(){}):Promise.resolve(e(o._queries[t].entities)).then(function(){});if(n&&n.then)return n.then(function(){})});o._systems.forEach(([e,t])=>{r?e(...r,o._queries[t].entities):e(o._queries[t].entities)})}();return c&&c.then?c.then(s):s()}var r=[].slice.call(arguments);const c=function(){if(o.config.onBefore)return Promise.resolve(o.config.onBefore(...r)).then(function(){})}();return Promise.resolve(c&&c.then?c.then(s):s())}catch(e){return Promise.reject(e)}}subscribe(e,t,n){const i=this.makeQueryKey(e),s=this.queryWithKey(i,e);return this._queries[i]?this._queries[i].callbacks.push(t):this._queries[i]={components:e,entities:s,callbacks:[t]},n&&t(s),()=>{this._queries[i]&&this._queries[i].callbacks.splice(this._queries[i].callbacks.indexOf(t),1)}}unsubscribe(e,t){const n=this.makeQueryKey(e);this._queries[n]&&this._queries[n].callbacks.splice(this._queries[n].callbacks.indexOf(t),1)}updateComponent(e,t,n){e[t.name]="function"==typeof n?n(e[t.name])||e[t.name]:n,Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&t.callbacks.forEach(e=>e(t.entities))})}},exports.getComponent=function(e,t){return e[t.name]},exports.hasComponent=function(e,t){return!!e[t.name]},exports.hasComponents=s;
//# sourceMappingURL=index.js.map
