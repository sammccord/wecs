{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["type Entity = { [componentName: string]: any }\n\ninterface IComponent<T> {\n  new(...args: any): T\n}\n\ntype QueryCallback = (entities: Entity[]) => void\n\ntype ComponentUpdater<T> = (component: T) => T\n\ninterface Query {\n  components: IComponent<unknown>[],\n  entities: Entity[]\n  callbacks: QueryCallback[]\n}\n\ninterface Config {\n  parallel?: boolean\n  onBefore?: (...args: any[]) => Promise<void>\n  onAfter?: (...args: any[]) => Promise<void>\n}\n\nexport function getComponent<T>(entity: Entity, Component: IComponent<T>): T {\n  return entity[Component.name]\n}\n\nexport function hasComponent<T>(entity: Entity, components: IComponent<T>) {\n  return !!entity[components.name]\n}\n\nexport function hasComponents(entity: Entity, components: IComponent<unknown>[]) {\n  return components.every(c => !!entity[c.name])\n}\n\nclass _Component<T>  {\n  constructor(obj = {}) {\n    Object.assign(this, obj)\n  }\n}\ntype Component<T> = _Component<T> & T\nexport const Component: new <T>(obj: T) => _Component<T> & T = _Component as any;\n\n// export function Generic<T>(obj: {} = {}): ExtendedProperties<T> {\n//   return new _Generic(obj) as ExtendedProperties<T>;\n// }\n// class _Generic<T> implements ExtendedProperties<T> {\n//   constructor(obj: {} = {}) {\n//     Object.assign(this, obj)\n//   }\n// }\n// function Generic<T>(json: string): MyClass & ExtendedProperties<T> {\n//   return new MyClass(json) as MyClass & ExtendedProperties<T>;\n// }\n\nexport class World {\n\n  protected config: Config = {}\n\n  private _systems: [Function, string][] = []\n  private _entities: Entity[] = []\n  private _queries: { [key: string]: Query } = {}\n\n  constructor(config: Config = {}) {\n    this.config = config\n  }\n\n  protected makeQueryKey(components: IComponent<unknown>[]): string {\n    return components.map(c => c.name).sort().join('-')\n  }\n\n  protected queryWithKey(key: string, components: IComponent<unknown>[], persist?: Boolean): Entity[] {\n    if (this._queries[key]) return this._queries[key].entities\n    const entities = this._entities.filter(e => hasComponents(e, components))\n    if (persist) this._queries[key] = { components, entities, callbacks: [] }\n    return entities\n  }\n\n  private _handleAddCallbacks(e: Entity) {\n    Object.values(this._queries).forEach(query => {\n      if (!query.entities.includes(e)) {\n        if (hasComponents(e, query.components)) {\n          query.entities.push(e)\n          query.callbacks.forEach(fn => fn(query.entities))\n        }\n      }\n    })\n  }\n\n  private _handleRemoveCallbacks(entity: Entity) {\n    Object.values(this._queries).forEach(query => {\n      if (!query.entities.includes(entity)) return\n      if (!hasComponents(entity, query.components)) {\n        query.entities.splice(query.entities.indexOf(entity), 1)\n        query.callbacks.forEach(fn => fn(query.entities))\n      }\n    })\n    if (!~Object.keys(entity).length) this._entities.splice(this._entities.indexOf(entity), 1)\n  }\n\n  public addComponent<T>(entity: Entity, Component: IComponent<T>, ...args: any[]) {\n    entity[Component.name] = new Component(...args)\n    this._handleAddCallbacks(entity)\n  }\n\n  public addComponents(entity: Entity, components: [IComponent<unknown>, ...any[]][]) {\n    if (!~components.length) return\n    components.forEach(([Constructor, ...args]) => {\n      entity[Constructor.name] = new Constructor(...args)\n    })\n    this._handleAddCallbacks(entity)\n  }\n\n  public createEntity(components: [IComponent<unknown>, ...any[]][]): Entity {\n    const entity: Entity = {}\n\n    components.forEach(([Constructor, ...args]) => {\n      entity[Constructor.name] = new Constructor(...args)\n    })\n\n    this._entities.push(entity)\n\n    Object.values(this._queries).forEach(query => {\n      if (hasComponents(entity, query.components)) {\n        query.entities.push(entity)\n      }\n\n      query.callbacks.forEach(fn => fn(query.entities))\n    })\n\n    return entity\n  }\n\n  public query(components: IComponent<unknown>[], persist?: Boolean): Entity[] {\n    const key = this.makeQueryKey(components)\n    return this.queryWithKey(key, components, persist)\n  }\n\n  public register(system: Function, components: IComponent<unknown>[]): void {\n    const key = this.makeQueryKey(components)\n    this._systems.push([system, key])\n    this._queries[key] = { components, entities: [], callbacks: [] }\n  }\n\n  public removeComponent<T>(entity: Entity, component: IComponent<T>) {\n    if (!component) return\n    delete entity[component.name]\n    this._handleRemoveCallbacks(entity)\n  }\n\n  public removeComponents(entity: Entity, components: IComponent<unknown>[]) {\n    if (!components || !~components.length) return\n    components.forEach(component => {\n      delete entity[component.name]\n    })\n    this._handleRemoveCallbacks(entity)\n  }\n\n  public async run(...args: any[]): Promise<void> {\n    if (this.config.onBefore) await this.config.onBefore(...args)\n    if (this.config.parallel) {\n      this._systems.forEach(([system, queryKey]) => {\n        if (args) system(...args, this._queries[queryKey].entities)\n        else system(this._queries[queryKey].entities)\n      })\n    } else {\n      for (let [system, queryKey] of this._systems) {\n        if (args) await system(...args, this._queries[queryKey].entities)\n        else await system(this._queries[queryKey].entities)\n      }\n    }\n    if (this.config.onAfter) await this.config.onAfter(...args)\n  }\n\n  public subscribe(components: IComponent<unknown>[], callback: QueryCallback, emit?: boolean): Function {\n    const key = this.makeQueryKey(components)\n    const entities = this.queryWithKey(key, components)\n    if (!!this._queries[key]) this._queries[key].callbacks.push(callback)\n    else this._queries[key] = {\n      components,\n      entities,\n      callbacks: [callback]\n    }\n    if (emit) callback(entities)\n    return () => {\n      if (!!this._queries[key]) {\n        this._queries[key].callbacks.splice(this._queries[key].callbacks.indexOf(callback), 1)\n      }\n    }\n  }\n\n  public unsubscribe(components: IComponent<unknown>[], callback: QueryCallback): void {\n    const key = this.makeQueryKey(components)\n    if (!!this._queries[key]) {\n      this._queries[key].callbacks.splice(this._queries[key].callbacks.indexOf(callback), 1)\n    }\n  }\n\n  public updateComponent<T>(entity: Entity, Component: IComponent<T>, update: any | ComponentUpdater<T>): void {\n    entity[Component.name] = typeof update === 'function' ? update(entity[Component.name]) || entity[Component.name] : update\n    Object.values(this._queries).forEach(query => {\n      if (query.entities.includes(entity)) {\n        query.callbacks.forEach(fn => fn(query.entities))\n      }\n    })\n  }\n}\n"],"names":["Symbol","iterator","pact","value","state","then","onFulfilled","callback","_settle","hasComponents","entity","components","every","c","name","constructor","obj","Object","assign","this","config","makeQueryKey","map","sort","join","queryWithKey","key","persist","_queries","entities","_entities","filter","e","callbacks","_handleAddCallbacks","values","forEach","query","includes","push","fn","_handleRemoveCallbacks","splice","indexOf","keys","length","addComponent","Component","addComponents","Constructor","args","createEntity","register","system","_systems","removeComponent","component","removeComponents","run","_this","onAfter","parallel","check","i","_cycle","result","reject","queryKey","onBefore","subscribe","emit","unsubscribe","updateComponent","update"],"mappings":"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"}