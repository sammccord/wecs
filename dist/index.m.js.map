{"version":3,"file":"index.m.js","sources":["../src/index.ts"],"sourcesContent":["type Entity = { [componentName: string]: any }\n\ninterface IComponent<T> {\n  new(...args: any): T\n}\n\ntype EntitiesCallback = (entities: Entity[]) => void\ntype ChangeCallback<T> = (entity: Entity, updates: ComponentUpdate<T>[]) => void\n\ntype ComponentUpdater<T> = (component: T) => T\ntype ComponentUpdate<T> = [IComponent<T>, any | ComponentUpdater<T>]\n\nclass _Component<T>  {\n  constructor(obj = {}) {\n    Object.assign(this, obj)\n  }\n}\ntype Component<T> = _Component<T> & T\nexport const Component: new <T>(obj: T) => _Component<T> & T = _Component as any;\nexport class ID extends Component<{ id: string }> { }\n\ninterface Query {\n  components: IComponent<unknown>[],\n  entities: Entity[]\n  subscriptions: EntitiesCallback[]\n  changeHandlers: ChangeCallback<any>[]\n}\n\ninterface Config {\n  parallel?: boolean\n  onBefore?: (...args: any[]) => Promise<void>\n  onAfter?: (...args: any[]) => Promise<void>\n}\n\nexport function getID(entity: Entity): string {\n  return entity[ID.name].id\n}\n\nexport function getComponent<T>(entity: Entity, Component: IComponent<T>): T {\n  return entity[Component.name]\n}\n\nexport function hasComponent<T>(entity: Entity, components: IComponent<T>) {\n  return !!entity[components.name]\n}\n\nexport function hasComponents(entity: Entity, components: IComponent<unknown>[]) {\n  return components.every(c => !!entity[c.name])\n}\n\nexport class World {\n\n  protected config: Config = {}\n\n  private _systems: [Function, string][] = []\n  private _entities: { [id: string]: Entity } = {}\n  private _queries: { [key: string]: Query } = {}\n\n  constructor(config: Config = {}) {\n    this.config = config\n  }\n\n  protected makeQueryKey(components: IComponent<unknown>[]): string {\n    return components.map(c => c.name).sort().join('-')\n  }\n\n  protected queryWithKey(key: string, components: IComponent<unknown>[], persist?: Boolean): Entity[] {\n    if (this._queries[key]) return this._queries[key].entities\n    const entities = Object.values(this._entities).filter(e => hasComponents(e, components))\n    if (persist) this._queries[key] = { components, entities, subscriptions: [], changeHandlers: [] }\n    return entities\n  }\n\n  private _handleAddCallbacks(e: Entity) {\n    Object.values(this._queries).forEach(query => {\n      if (!query.entities.includes(e)) {\n        if (hasComponents(e, query.components)) {\n          query.entities.push(e)\n          query.subscriptions.forEach(fn => fn(query.entities))\n        }\n      }\n    })\n  }\n\n  private _handleRemoveCallbacks(entity: Entity) {\n    Object.values(this._queries).forEach(query => {\n      if (!query.entities.includes(entity)) return\n      if (!hasComponents(entity, query.components)) {\n        query.entities.splice(query.entities.indexOf(entity), 1)\n        query.subscriptions.forEach(fn => fn(query.entities))\n      }\n    })\n    if (Object.keys(entity).length === 1) delete this._entities[entity.ID.id]\n  }\n\n  public addComponent<T>(entity: Entity, Component: IComponent<T>, ...args: any[]) {\n    entity[Component.name] = new Component(...args)\n    this._handleAddCallbacks(entity)\n  }\n\n  public addComponents(entity: Entity, components: [IComponent<unknown>, ...any[]][]) {\n    if (!~components.length) return\n    components.forEach(([Constructor, ...args]) => {\n      entity[Constructor.name] = new Constructor(...args)\n    })\n    this._handleAddCallbacks(entity)\n  }\n\n  public createEntity(components: [IComponent<unknown>, ...any[]][]): Entity {\n    const entity: Entity = {}\n    components.forEach(([Constructor, ...args]) => {\n      entity[Constructor.name] = new Constructor(...args)\n    })\n    if (!entity.ID) entity.ID = new ID({ id: String(new Date().valueOf()) })\n    this._entities[entity.ID.id] = entity\n    Object.values(this._queries).forEach(query => {\n      if (hasComponents(entity, query.components)) query.entities.push(entity)\n      query.subscriptions.forEach(fn => fn(query.entities))\n    })\n    return entity\n  }\n\n  public get(id: string): Entity {\n    return this._entities[id]\n  }\n\n  public query(components: IComponent<unknown>[], persist?: Boolean): Entity[] {\n    const key = this.makeQueryKey(components)\n    return this.queryWithKey(key, components, persist)\n  }\n\n  public register(system: Function, components: IComponent<unknown>[]): void {\n    const key = this.makeQueryKey(components)\n    this._systems.push([system, key])\n    this._queries[key] = { components, entities: [], subscriptions: [], changeHandlers: [] }\n  }\n\n  public removeComponent<T>(entity: Entity, component: IComponent<T>) {\n    if (!component || component.name === ID.name) return\n    delete entity[component.name]\n    this._handleRemoveCallbacks(entity)\n  }\n\n  public removeComponents(entity: Entity, components: IComponent<unknown>[]) {\n    if (!components || !~components.length) return\n    components.forEach(component => {\n      if (component.name === ID.name) return\n      delete entity[component.name]\n    })\n    this._handleRemoveCallbacks(entity)\n  }\n\n  public async run(...args: any[]): Promise<void> {\n    if (this.config.onBefore) await this.config.onBefore(...args)\n    if (this.config.parallel) {\n      this._systems.forEach(([system, queryKey]) => {\n        if (args) system(...args, this._queries[queryKey].entities)\n        else system(this._queries[queryKey].entities)\n      })\n    } else {\n      for (let [system, queryKey] of this._systems) {\n        if (args) await system(...args, this._queries[queryKey].entities)\n        else await system(this._queries[queryKey].entities)\n      }\n    }\n    if (this.config.onAfter) await this.config.onAfter(...args)\n  }\n\n  public subscribe(components: IComponent<unknown>[], callback: EntitiesCallback, emit?: boolean): () => void {\n    return this.makeSubscription(components, emit)(callback)\n  }\n\n  public makeSubscription(components: IComponent<unknown>[], emit?: boolean): (cb: EntitiesCallback) => () => void {\n    const key = this.makeQueryKey(components)\n    return (callback) => {\n      const entities = this.queryWithKey(key, components)\n      if (!!this._queries[key]) this._queries[key].subscriptions.push(callback)\n      else this._queries[key] = { components, entities, subscriptions: [callback], changeHandlers: [] }\n      if (emit) callback(entities)\n      return () => {\n        if (!!this._queries[key]) {\n          this._queries[key].subscriptions.splice(this._queries[key].subscriptions.indexOf(callback), 1)\n        }\n      }\n    }\n  }\n\n  public handleChange(components: IComponent<unknown>[], callback: ChangeCallback<unknown>): () => void {\n    return this.makeChangeHandler(components)(callback)\n  }\n\n  public makeChangeHandler(components: IComponent<unknown>[]): (cb: ChangeCallback<unknown>) => () => void {\n    const key = this.makeQueryKey(components)\n    return (callback) => {\n      if (!!this._queries[key]) this._queries[key].changeHandlers.push(callback)\n      else this._queries[key] = { components, entities: this.queryWithKey(key, components), subscriptions: [], changeHandlers: [callback] }\n      return () => {\n        if (!!this._queries[key]) {\n          this._queries[key].changeHandlers.splice(this._queries[key].changeHandlers.indexOf(callback), 1)\n        }\n      }\n    }\n  }\n\n  public unsubscribe(components: IComponent<unknown>[], callback: EntitiesCallback): void {\n    const key = this.makeQueryKey(components)\n    if (!!this._queries[key]) {\n      this._queries[key].subscriptions.splice(this._queries[key].subscriptions.indexOf(callback), 1)\n    }\n  }\n\n  public deregisterHandler(components: IComponent<unknown>[], callback: ChangeCallback<unknown>): void {\n    const key = this.makeQueryKey(components)\n    if (!!this._queries[key]) {\n      this._queries[key].subscriptions.splice(this._queries[key].changeHandlers.indexOf(callback), 1)\n    }\n  }\n\n  public updateComponent<T>(entity: Entity, Component: IComponent<T>, update: any | ComponentUpdater<T>): T {\n    const _update = this._update(entity, Component, update)\n    Object.values(this._queries).forEach(query => {\n      if (query.entities.includes(entity)) {\n        query.subscriptions.forEach(fn => fn(query.entities))\n        query.changeHandlers.forEach(fn => fn(entity, [[Component, _update]]))\n      }\n    })\n    return _update\n  }\n\n  public updateComponents(entity: Entity, updates: ComponentUpdate<any>[]): any[] {\n    const _updates = updates.map(([Component, update]) => ([Component, this._update(entity, Component, update)])) as [IComponent<any>, any][]\n    Object.values(this._queries).forEach(query => {\n      if (query.entities.includes(entity)) {\n        query.subscriptions.forEach(fn => fn(query.entities))\n        query.changeHandlers.forEach(fn => fn(entity, _updates))\n      }\n    })\n    return _updates\n  }\n\n  private _update<T>(entity: Entity, Component: IComponent<T>, update: any | ComponentUpdater<T>): any {\n    entity[Component.name] = typeof update === 'function' ? update(entity[Component.name]) || entity[Component.name] : update\n    return entity[Component.name]\n  }\n}\n"],"names":["pact","value","state","bind","observer","o","_this","onFulfilled","onRejected","_settle","thenable","Component","constructor","obj","Object","assign","this","ID","getID","entity","name","id","getComponent","hasComponent","components","hasComponents","every","c","World","config","makeQueryKey","map","sort","join","queryWithKey","key","persist","_queries","entities","values","_entities","filter","e","subscriptions","changeHandlers","_handleAddCallbacks","forEach","query","includes","push","fn","_handleRemoveCallbacks","splice","indexOf","keys","length","addComponent","addComponents","Constructor","args","createEntity","String","Date","valueOf","get","register","system","_systems","removeComponent","component","removeComponents","run","onAfter","parallel","result","then","check","i","_cycle","reject","queryKey","onBefore","subscribe","callback","emit","makeSubscription","handleChange","makeChangeHandler","unsubscribe","deregisterHandler","updateComponent","update","_update","updateComponents","updates","_updates"],"mappings":"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"}