{"version":3,"file":"index.umd.js","sources":["../src/index.ts"],"sourcesContent":["type Entity = {}\n\ninterface Component<T> {\n  new(...args: any): T\n  name: string\n}\n\ntype QueryCallback = (entities: Entity[]) => void\n\ninterface Query {\n  components: Component<unknown>[],\n  entities: Entity[]\n  callbacks: QueryCallback[]\n}\n\ninterface Config {\n  parallel?: boolean\n  onBefore?: (...args: any[]) => Promise<void>\n  onAfter?: (...args: any[]) => Promise<void>\n}\n\nexport function getComponent<T>(entity: Entity, Component: Component<T>): T {\n  return entity[Component.name]\n}\n\nexport function hasComponent<T>(entity: Entity, components: Component<T>) {\n  return !!entity[components.name]\n}\n\nexport function hasComponents(entity: Entity, components: Component<unknown>[]) {\n  return components.every(c => !!entity[c.name])\n}\n\nexport class World {\n\n  protected config: Config = {}\n\n  private _systems: [Function, string][] = []\n  private _entities: Entity[] = []\n  private _queries: { [key: string]: Query } = {}\n\n  constructor(config?: Config) {\n    this.config = config || {}\n  }\n\n  protected makeQueryKey(components: Component<unknown>[]): string {\n    return components.map(c => c.name).sort().join('-')\n  }\n\n  protected queryWithKey(key, components: Component<unknown>[], persist?: Boolean): Entity[] {\n    if (this._queries[key]) return this._queries[key].entities\n    const entities = this._entities.filter(e => hasComponents(e, components))\n    if (persist) this._queries[key] = { components, entities, callbacks: [] }\n    return entities\n  }\n\n  private _handleAddCallbacks(e: Entity) {\n    Object.values(this._queries).forEach(query => {\n      if (!query.entities.includes(e)) {\n        if (hasComponents(e, query.components)) {\n          query.entities.push(e)\n          query.callbacks.forEach(fn => fn(query.entities))\n        }\n      }\n    })\n  }\n\n  private _handleRemoveCallbacks(entity: Entity) {\n    Object.values(this._queries).forEach(query => {\n      if (!query.entities.includes(entity)) return\n      if (!hasComponents(entity, query.components)) {\n        query.entities.splice(query.entities.indexOf(entity), 1)\n        query.callbacks.forEach(fn => fn(query.entities))\n      }\n    })\n    if (!~Object.keys(entity).length) this._entities.splice(this._entities.indexOf(entity), 1)\n  }\n\n  public addComponent<T>(entity: Entity, Component: Component<T>, ...args: any[]) {\n    entity[Component.name] = new Component(...args)\n    this._handleAddCallbacks(entity)\n  }\n\n  public addComponents(entity: Entity, components: [Component<unknown>, ...any[]][]) {\n    if (!~components.length) return\n    components.forEach(([Constructor, ...args]) => {\n      entity[Constructor.name] = new Constructor(...args)\n    })\n    this._handleAddCallbacks(entity)\n  }\n\n  public createEntity(components: [Component<unknown>, ...any[]][]): Entity {\n    const entity: Entity = {}\n\n    components.forEach(([Constructor, ...args]) => {\n      entity[Constructor.name] = new Constructor(...args)\n    })\n\n    this._entities.push(entity)\n\n    Object.values(this._queries).forEach(query => {\n      if (hasComponents(entity, query.components)) {\n        query.entities.push(entity)\n      }\n\n      query.callbacks.forEach(fn => fn(query.entities))\n    })\n\n    return entity\n  }\n\n  public query(components: Component<unknown>[], persist?: Boolean): Entity[] {\n    const key = this.makeQueryKey(components)\n    return this.queryWithKey(key, components, persist)\n  }\n\n  public register(system: Function, components: Component<unknown>[]): void {\n    const key = this.makeQueryKey(components)\n    this._systems.push([system, key])\n    this._queries[key] = { components, entities: [], callbacks: [] }\n  }\n\n  public removeComponent<T>(entity: Entity, component: Component<T>) {\n    if (!component) return\n    delete entity[component.name]\n    this._handleRemoveCallbacks(entity)\n  }\n\n  public removeComponents(entity: Entity, components: Component<unknown>[]) {\n    if (!components || !~components.length) return\n    components.forEach(component => {\n      delete entity[component.name]\n    })\n    this._handleRemoveCallbacks(entity)\n  }\n\n  public async run(...args: any[]): Promise<void> {\n    if (this.config.onBefore) await this.config.onBefore(...args)\n    if (this.config.parallel) {\n      this._systems.forEach(([system, queryKey]) => {\n        if (args) system(...args, this._queries[queryKey].entities)\n        else system(this._queries[queryKey].entities)\n      })\n    } else {\n      for (let [system, queryKey] of this._systems) {\n        if (args) await system(...args, this._queries[queryKey].entities)\n        else await system(this._queries[queryKey].entities)\n      }\n    }\n    if (this.config.onAfter) await this.config.onAfter(...args)\n  }\n\n  public subscribe(components: Component<unknown>[], callback: QueryCallback, emit?: boolean): Function {\n    const key = this.makeQueryKey(components)\n    const entities = this.queryWithKey(key, components)\n    if (!!this._queries[key]) this._queries[key].callbacks.push(callback)\n    else this._queries[key] = {\n      components,\n      entities,\n      callbacks: [callback]\n    }\n    if (emit) callback(entities)\n    return () => {\n      if (!!this._queries[key]) {\n        this._queries[key].callbacks.splice(this._queries[key].callbacks.indexOf(callback), 1)\n      }\n    }\n  }\n\n  public unsubscribe(components: Component<unknown>[], callback: QueryCallback): void {\n    const key = this.makeQueryKey(components)\n    if (!!this._queries[key]) {\n      this._queries[key].callbacks.splice(this._queries[key].callbacks.indexOf(callback), 1)\n    }\n  }\n\n  public updateComponent<T>(entity: Entity, Component, updater: (component: T) => T): void {\n    entity[Component.name] = updater(entity[Component.name]) || entity[Component.name]\n    Object.values(this._queries).forEach(query => {\n      if (query.entities.includes(entity)) {\n        query.callbacks.forEach(fn => fn(query.entities))\n      }\n    })\n  }\n}\n"],"names":["hasComponents","entity","components","every","c","name","constructor","config","this","makeQueryKey","map","sort","join","queryWithKey","key","persist","_queries","entities","_entities","filter","e","callbacks","_handleAddCallbacks","Object","values","forEach","query","includes","push","fn","_handleRemoveCallbacks","splice","indexOf","keys","length","addComponent","Component","args","addComponents","Constructor","createEntity","register","system","_systems","removeComponent","component","removeComponents","[object Object]","onBefore","parallel","queryKey","onAfter","subscribe","callback","emit","unsubscribe","updateComponent","updater"],"mappings":"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"}