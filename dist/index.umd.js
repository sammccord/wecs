!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).wecs={})}(this,function(e){const t="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function n(e,t,s){if(!e.s){if(s instanceof i){if(!s.s)return void(s.o=n.bind(null,e,t));1&t&&(t=s.s),s=s.v}if(s&&s.then)return void s.then(n.bind(null,e,t),n.bind(null,e,2));e.s=t,e.v=s;const r=e.o;r&&r(e)}}const i=function(){function e(){}return e.prototype.then=function(t,i){const s=new e,r=this.s;if(r){const e=1&r?t:i;if(e){try{n(s,1,e(this.v))}catch(e){n(s,2,e)}return s}return this}return this.o=function(e){try{const r=e.v;1&e.s?n(s,1,t?t(r):r):i?n(s,1,i(r)):n(s,2,r)}catch(e){n(s,2,e)}},s},e}();function s(e){return e instanceof i&&1&e.s}function r(e,t){return t.every(t=>!!e[t.name])}const o=class{constructor(e={}){Object.assign(this,e)}};class c extends o{}e.Component=o,e.ID=c,e.World=class{constructor(e={}){this.config={},this._systems=[],this._entities={},this._queries={},this.config=e}makeQueryKey(e){return e.map(e=>e.name).sort().join("-")}queryWithKey(e,t,n){if(this._queries[e])return this._queries[e].entities;const i=Object.values(this._entities).filter(e=>r(e,t));return n&&(this._queries[e]={components:t,entities:i,callbacks:[]}),i}_handleAddCallbacks(e){Object.values(this._queries).forEach(t=>{t.entities.includes(e)||r(e,t.components)&&(t.entities.push(e),t.callbacks.forEach(e=>e(t.entities)))})}_handleRemoveCallbacks(e){Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&(r(e,t.components)||(t.entities.splice(t.entities.indexOf(e),1),t.callbacks.forEach(e=>e(t.entities))))}),1===Object.keys(e).length&&delete this._entities[e.ID.id]}addComponent(e,t){e[t.name]=new t(...[].slice.call(arguments,2)),this._handleAddCallbacks(e)}addComponents(e,t){~t.length&&(t.forEach(([t,...n])=>{e[t.name]=new t(...n)}),this._handleAddCallbacks(e))}createEntity(e){const t={};return e.forEach(([e,...n])=>{t[e.name]=new e(...n)}),t.ID||(t.ID=new c({id:String((new Date).valueOf())})),this._entities[t.ID.id]=t,Object.values(this._queries).forEach(e=>{r(t,e.components)&&e.entities.push(t),e.callbacks.forEach(t=>t(e.entities))}),t}get(e){return this._entities[e]}query(e,t){const n=this.makeQueryKey(e);return this.queryWithKey(n,e,t)}register(e,t){const n=this.makeQueryKey(t);this._systems.push([e,n]),this._queries[n]={components:t,entities:[],callbacks:[]}}removeComponent(e,t){t&&t.name!==c.name&&(delete e[t.name],this._handleRemoveCallbacks(e))}removeComponents(e,t){t&&~t.length&&(t.forEach(t=>{t.name!==c.name&&delete e[t.name]}),this._handleRemoveCallbacks(e))}run(){try{const o=this;function e(){function e(){const e=function(){if(o.config.onAfter)return Promise.resolve(o.config.onAfter(...r)).then(function(){})}();if(e&&e.then)return e.then(function(){})}const c=function(){if(!o.config.parallel)return function(e,r,o){if("function"==typeof e[t]){var c,u,a,h=e[t]();if(function e(t){try{for(;!(c=h.next()).done;)if((t=r(c.value))&&t.then){if(!s(t))return void t.then(e,a||(a=n.bind(null,u=new i,2)));t=t.v}u?n(u,1,t):u=t}catch(e){n(u||(u=new i),2,e)}}(),h.return){var l=function(e){try{c.done||h.return()}catch(e){}return e};if(u&&u.then)return u.then(l,function(e){throw l(e)});l()}return u}if(!("length"in e))throw new TypeError("Object is not iterable");for(var f=[],m=0;m<e.length;m++)f.push(e[m]);return function(e,t,r){var o,c,u=-1;return function r(a){try{for(;++u<e.length;)if((a=t(u))&&a.then){if(!s(a))return void a.then(r,c||(c=n.bind(null,o=new i,2)));a=a.v}o?n(o,1,a):o=a}catch(e){n(o||(o=new i),2,e)}}(),o}(f,function(e){return r(f[e])})}(o._systems,function([e,t]){const n=r?Promise.resolve(e(...r,o._queries[t].entities)).then(function(){}):Promise.resolve(e(o._queries[t].entities)).then(function(){});if(n&&n.then)return n.then(function(){})});o._systems.forEach(([e,t])=>{r?e(...r,o._queries[t].entities):e(o._queries[t].entities)})}();return c&&c.then?c.then(e):e()}var r=[].slice.call(arguments);const c=function(){if(o.config.onBefore)return Promise.resolve(o.config.onBefore(...r)).then(function(){})}();return Promise.resolve(c&&c.then?c.then(e):e())}catch(e){return Promise.reject(e)}}subscribe(e,t,n){const i=this.makeQueryKey(e),s=this.queryWithKey(i,e);return this._queries[i]?this._queries[i].callbacks.push(t):this._queries[i]={components:e,entities:s,callbacks:[t]},n&&t(s),()=>{this._queries[i]&&this._queries[i].callbacks.splice(this._queries[i].callbacks.indexOf(t),1)}}unsubscribe(e,t){const n=this.makeQueryKey(e);this._queries[n]&&this._queries[n].callbacks.splice(this._queries[n].callbacks.indexOf(t),1)}updateComponent(e,t,n){e[t.name]="function"==typeof n?n(e[t.name])||e[t.name]:n,Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&t.callbacks.forEach(e=>e(t.entities))})}},e.getComponent=function(e,t){return e[t.name]},e.getID=function(e){return e[c.name].id},e.hasComponent=function(e,t){return!!e[t.name]},e.hasComponents=r});
//# sourceMappingURL=index.umd.js.map
