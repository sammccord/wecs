!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).wecs={})}(this,function(e){const t="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function n(e,t,s){if(!e.s){if(s instanceof i){if(!s.s)return void(s.o=n.bind(null,e,t));1&t&&(t=s.s),s=s.v}if(s&&s.then)return void s.then(n.bind(null,e,t),n.bind(null,e,2));e.s=t,e.v=s;const r=e.o;r&&r(e)}}const i=function(){function e(){}return e.prototype.then=function(t,i){const s=new e,r=this.s;if(r){const e=1&r?t:i;if(e){try{n(s,1,e(this.v))}catch(e){n(s,2,e)}return s}return this}return this.o=function(e){try{const r=e.v;1&e.s?n(s,1,t?t(r):r):i?n(s,1,i(r)):n(s,2,r)}catch(e){n(s,2,e)}},s},e}();function s(e){return e instanceof i&&1&e.s}const r=class{constructor(e={}){Object.assign(this,e)}};class o extends r{}function u(e,t){return t.every(t=>!!e[t.name])}e.Component=r,e.ID=o,e.World=class{constructor(e={}){this.config={},this._systems=[],this._entities={},this._queries={},this.config=e}makeQueryKey(e){return e.map(e=>e.name).sort().join("-")}queryWithKey(e,t,n){if(this._queries[e])return this._queries[e].entities;const i=Object.values(this._entities).filter(e=>u(e,t));return n&&(this._queries[e]={components:t,entities:i,subscriptions:[],changeHandlers:[]}),i}_handleAddCallbacks(e){Object.values(this._queries).forEach(t=>{t.entities.includes(e)||u(e,t.components)&&(t.entities.push(e),t.subscriptions.forEach(e=>e(t.entities)))})}_handleRemoveCallbacks(e){Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&(u(e,t.components)||(t.entities.splice(t.entities.indexOf(e),1),t.subscriptions.forEach(e=>e(t.entities))))}),1===Object.keys(e).length&&delete this._entities[e.ID.id]}addComponent(e,t){e[t.name]=new t(...[].slice.call(arguments,2)),this._handleAddCallbacks(e)}addComponents(e,t){~t.length&&(t.forEach(([t,...n])=>{e[t.name]=new t(...n)}),this._handleAddCallbacks(e))}createEntity(e){const t={};return e.forEach(([e,...n])=>{t[e.name]=new e(...n)}),t.ID||(t.ID=new o({id:String((new Date).valueOf())})),this._entities[t.ID.id]=t,Object.values(this._queries).forEach(e=>{u(t,e.components)&&e.entities.push(t),e.subscriptions.forEach(t=>t(e.entities))}),t}get(e){return this._entities[e]}query(e,t){const n=this.makeQueryKey(e);return this.queryWithKey(n,e,t)}register(e,t){const n=this.makeQueryKey(t);this._systems.push([e,n]),this._queries[n]={components:t,entities:[],subscriptions:[],changeHandlers:[]}}removeComponent(e,t){t&&t.name!==o.name&&(delete e[t.name],this._handleRemoveCallbacks(e))}removeComponents(e,t){t&&~t.length&&(t.forEach(t=>{t.name!==o.name&&delete e[t.name]}),this._handleRemoveCallbacks(e))}run(){try{const o=this;function e(){function e(){const e=function(){if(o.config.onAfter)return Promise.resolve(o.config.onAfter(...r)).then(function(){})}();if(e&&e.then)return e.then(function(){})}const u=function(){if(!o.config.parallel)return function(e,r,o){if("function"==typeof e[t]){var u,c,h,a=e[t]();if(function e(t){try{for(;!(u=a.next()).done;)if((t=r(u.value))&&t.then){if(!s(t))return void t.then(e,h||(h=n.bind(null,c=new i,2)));t=t.v}c?n(c,1,t):c=t}catch(e){n(c||(c=new i),2,e)}}(),a.return){var f=function(e){try{u.done||a.return()}catch(e){}return e};if(c&&c.then)return c.then(f,function(e){throw f(e)});f()}return c}if(!("length"in e))throw new TypeError("Object is not iterable");for(var l=[],d=0;d<e.length;d++)l.push(e[d]);return function(e,t,r){var o,u,c=-1;return function r(h){try{for(;++c<e.length;)if((h=t(c))&&h.then){if(!s(h))return void h.then(r,u||(u=n.bind(null,o=new i,2)));h=h.v}o?n(o,1,h):o=h}catch(e){n(o||(o=new i),2,e)}}(),o}(l,function(e){return r(l[e])})}(o._systems,function([e,t]){const n=r?Promise.resolve(e(...r,o._queries[t].entities)).then(function(){}):Promise.resolve(e(o._queries[t].entities)).then(function(){});if(n&&n.then)return n.then(function(){})});o._systems.forEach(([e,t])=>{r?e(...r,o._queries[t].entities):e(o._queries[t].entities)})}();return u&&u.then?u.then(e):e()}var r=[].slice.call(arguments);const u=function(){if(o.config.onBefore)return Promise.resolve(o.config.onBefore(...r)).then(function(){})}();return Promise.resolve(u&&u.then?u.then(e):e())}catch(e){return Promise.reject(e)}}subscribe(e,t,n){return this.makeSubscription(e,n)(t)}makeSubscription(e,t){const n=this.makeQueryKey(e);return i=>{const s=this.queryWithKey(n,e);return this._queries[n]?this._queries[n].subscriptions.push(i):this._queries[n]={components:e,entities:s,subscriptions:[i],changeHandlers:[]},t&&i(s),()=>{this._queries[n]&&this._queries[n].subscriptions.splice(this._queries[n].subscriptions.indexOf(i),1)}}}handleChange(e,t){return this.makeChangeHandler(e)(t)}makeChangeHandler(e){const t=this.makeQueryKey(e);return n=>(this._queries[t]?this._queries[t].changeHandlers.push(n):this._queries[t]={components:e,entities:this.queryWithKey(t,e),subscriptions:[],changeHandlers:[n]},()=>{this._queries[t]&&this._queries[t].changeHandlers.splice(this._queries[t].changeHandlers.indexOf(n),1)})}unsubscribe(e,t){const n=this.makeQueryKey(e);this._queries[n]&&this._queries[n].subscriptions.splice(this._queries[n].subscriptions.indexOf(t),1)}deregisterHandler(e,t){const n=this.makeQueryKey(e);this._queries[n]&&this._queries[n].subscriptions.splice(this._queries[n].changeHandlers.indexOf(t),1)}updateComponent(e,t,n){const i=this._update(e,t,n);return Object.values(this._queries).forEach(n=>{n.entities.includes(e)&&(n.subscriptions.forEach(e=>e(n.entities)),n.changeHandlers.forEach(n=>n(e,[[t,i]])))}),i}updateComponents(e,t){const n=t.map(([t,n])=>[t,this._update(e,t,n)]);return Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&(t.subscriptions.forEach(e=>e(t.entities)),t.changeHandlers.forEach(t=>t(e,n)))}),n}_update(e,t,n){return e[t.name]="function"==typeof n?n(e[t.name])||e[t.name]:n,e[t.name]}},e.getComponent=function(e,t){return e[t.name]},e.getID=function(e){return e[o.name].id},e.hasComponent=function(e,t){return!!e[t.name]},e.hasComponents=u});
//# sourceMappingURL=index.umd.js.map
