!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).wecs={})}(this,function(e){function t(e,t){return t.every(t=>!!e[t.name])}e.World=class{constructor(e){this.config={},this._systems=[],this._entities=[],this._queries={},this.config=e||{}}makeQueryKey(e){return e.map(e=>e.name).sort().join("-")}queryWithKey(e,s,i){if(this._queries[e])return this._queries[e].entities;var n=this._entities.filter(e=>t(e,s));return i&&(this._queries[e]={components:s,entities:n,callbacks:[]}),n}_handleAddCallbacks(e){Object.values(this._queries).forEach(s=>{s.entities.includes(e)||t(e,s.components)&&(s.entities.push(e),s.callbacks.forEach(e=>e(s.entities)))})}_handleRemoveCallbacks(e){Object.values(this._queries).forEach(s=>{s.entities.includes(e)&&(t(e,s.components)||(s.entities.splice(s.entities.indexOf(e),1),s.callbacks.forEach(e=>e(s.entities))))}),~Object.keys(e).length||this._entities.splice(this._entities.indexOf(e),1)}addComponent(e,t){for(var s=arguments.length,i=new Array(s>2?s-2:0),n=2;n<s;n++)i[n-2]=arguments[n];e[t.name]=new t(...i),this._handleAddCallbacks(e)}addComponents(e,t){~t.length&&(t.forEach(t=>{var[s,...i]=t;e[s.name]=new s(...i)}),this._handleAddCallbacks(e))}createEntity(e){var s={};return e.forEach(e=>{var[t,...i]=e;s[t.name]=new t(...i)}),this._entities.push(s),Object.values(this._queries).forEach(e=>{t(s,e.components)&&e.entities.push(s),e.callbacks.forEach(t=>t(e.entities))}),s}query(e,t){var s=this.makeQueryKey(e);return this.queryWithKey(s,e,t)}register(e,t){var s=this.makeQueryKey(t);this._systems.push([e,s]),this._queries[s]={components:t,entities:[],callbacks:[]}}removeComponent(e,t){t&&(delete e[t.name],this._handleRemoveCallbacks(e))}removeComponents(e,t){t&&~t.length&&(t.forEach(t=>{delete e[t.name]}),this._handleRemoveCallbacks(e))}async run(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];if(this.config.onBefore&&await this.config.onBefore(...t),this.config.parallel)this._systems.forEach(e=>{var[s,i]=e;t?s(...t,this._queries[i].entities):s(this._queries[i].entities)});else for(var[i,n]of this._systems)t?await i(...t,this._queries[n].entities):await i(this._queries[n].entities);this.config.onAfter&&await this.config.onAfter(...t)}subscribe(e,t,s){var i=this.makeQueryKey(e),n=this.queryWithKey(i,e);return this._queries[i]?this._queries[i].callbacks.push(t):this._queries[i]={components:e,entities:n,callbacks:[t]},s&&t(n),()=>{this._queries[i]&&this._queries[i].callbacks.splice(this._queries[i].callbacks.indexOf(t),1)}}unsubscribe(e,t){var s=this.makeQueryKey(e);this._queries[s]&&this._queries[s].callbacks.splice(this._queries[s].callbacks.indexOf(t),1)}updateComponent(e,t,s){e[t.name]="function"==typeof s?s(e[t.name])||e[t.name]:s,Object.values(this._queries).forEach(t=>{t.entities.includes(e)&&t.callbacks.forEach(e=>e(t.entities))})}},e.getComponent=function(e,t){return e[t.name]},e.hasComponent=function(e,t){return!!e[t.name]},e.hasComponents=t});
//# sourceMappingURL=index.umd.js.map
